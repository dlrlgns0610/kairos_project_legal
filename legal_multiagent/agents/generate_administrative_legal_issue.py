#쟁점 분석 에이전트

from typing import List
from openai import OpenAI
import json
import os
from dotenv import load_dotenv

load_dotenv(override=True)

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")

#openai
client = OpenAI(api_key = OPENAI_API_KEY)

def generate_legal_issue(description: str, basic_facts: list[str], case_categories: list[str]) -> str:
    category_str = ', '.join(case_categories)
    facts_str = "\n".join(basic_facts)
    messages = [
        {
            "role": "system",
            "content": f"""
            **역할**
            당신은 행정 사건의 법적 쟁점을 분석하고 추출하는 전문 에이전트입니다. 사용자(클라이언트)로부터 행정 사건의 **정리된 법률 사실 관계**를 입력받아, 해당 사실 관계로부터 도출될 수 있는 **모든 법적 쟁점**을 빠짐없이 분석하고 추출하여 제공해야 합니다.

            **분석 대상 사건 분야: {category_str}**

            **법적 쟁점 추출 지침**:
1.  **법률 요건 사실과의 연결**:
    * 제시된 사실 관계가 행정법, 행정소송법 등 **관련 행정 법규의 특정 조항이나 법리(판례)의 요건 사실**을 충족하는지 여부를 중심으로 쟁점을 도출합니다.
    * 각 쟁점은 해당 사실 관계에 어떤 행정 법규범이 적용될 수 있는지를 명확히 보여주어야 합니다.

2.  **분쟁의 핵심 구체화**:
    * 행정청의 처분이 법률상 문제가 있는지, 개인의 권리가 침해되었는지, 그리고 어떤 구제 방법이 필요한지 등 **법적 판단이 필요한 핵심 질문** 형태로 구체화합니다.

3.  **행정 사건 특유의 필수 쟁점 고려**:
    * **처분성 인정 여부**: 대상 행위가 항고소송의 대상이 되는 '처분'에 해당하는가?
    * **처분 주체의 권한 유무**: 처분을 내린 행정청이 법률상 해당 처분을 할 권한을 가지고 있었는가?
    * **절차적 위법 여부**: 처분 과정에서 행정절차법 등 관련 법령에 규정된 절차(예: 사전 통지, 의견 제출 기회, 청문)를 적법하게 준수하였는가?
    * **내용상 위법/부당 여부**:
        * **법규 위반**: 처분의 내용이 관련 법령에 직접 위배되는가?
        * **사실 오인**: 처분의 근거가 된 사실 관계를 행정청이 잘못 인식하였는가?
        * **재량권 일탈/남용**: 처분이 비례의 원칙, 평등의 원칙 등 행정법의 일반 원칙을 위반하여 재량권을 일탈하거나 남용한 것인가? (특히 처분으로 인한 개인의 불이익이 과도한 경우)
    * **불복 절차의 적법성/유효성**: 이의 신청, 행정심판, 행정소송 등 제기된 불복 절차가 적법하게 진행되었고 그 효과가 유효한가?
    * **소송 요건 충족 여부**: 제소기간 준수, 원고 적격 등 행정소송 제기를 위한 요건이 충족되었는가?

4.  **포괄성 및 중복 배제**:
    * 제시된 모든 사실 관계로부터 파생될 수 있는 **가능한 모든 쟁점**을 빠짐없이 추출합니다.
    * 동일한 내용을 중복하여 쟁점으로 제시하지 않고, 각 쟁점이 독립적이면서도 상호 보완적으로 구성되도록 합니다.

5.  **질문 또는 ~여부 형식**:
    * 각 법적 쟁점은 명확한 **질문 형식("~인가?", "~여부?")**으로 표현하여, 법률적 판단을 필요로 하는 지점임을 분명히 합니다.
    * 문장 끝에 반드시 물음표(?) 또는 '여부'로 끝나는 형식을 사용합니다.

6.  **논리적 순서**:
    * 여러 쟁점이 도출될 경우, **절차적 하자 → 내용상 하자(법규 위반 → 사실 오인 → 재량권 일탈/남용) → 소송 요건**과 같이 행정소송의 판단 흐름에 따라 쟁점을 배열합니다.

7.  **객관성 유지**:
    * **의견, 감정, 주관적인 주장, 해결책 제시, 사건 결과 예측**은 **절대 포함하지 않습니다**. 오직 사실 관계로부터 도출되는 법률적 쟁점 그 자체만을 객관적으로 제시합니다.

**출력 형식**:
결과는 반드시 `legal_issues`라는 키를 가진 JSON 객체 형태로 반환해야 합니다. `legal_issues`의 값은 추출된 각 법적 쟁점을 '\n'으로 구분하여 나열한 하나의 문자열입니다.

**출력 예시**:
```json
{{
  "legal_issues": "1. 이 사건 처분이 항고소송의 대상이 되는 '처분'에 해당하는가?\n2. 처분 과정에서 절차적 하자가 존재하는가?\n3. 처분이 사실을 오인하여 위법한가?"
}}

##사건 내용:##
{{
  "basic_facts": [
    "1. 원고 김철수가 운영하는 카페 '향기로운 쉼터'가 2024년 5월 15일 오후 2시경 A구청 위생과 직원으로부터 위생 점검을 받았다.",
    "2. 위 점검 당시 원고 카페 직원이 위생 모자를 착용하지 않은 사실이 적발되었다.",
    "3. A구청은 위 적발 사실을 근거로 2024년 5월 25일 원고에게 '식품위생법 제75조 위반'을 사유로 한 영업정지 1개월 처분 통지서를 발송하였다.",
    "4. 위 처분에 따라 원고 카페는 2024년 6월 1일부터 1개월간 영업을 중단하게 되었다.",
    "5. 원고는 위 영업정지 처분으로 인해 약 수천만원의 매출 손실이 발생할 것으로 예상하고 있다."
  ]
}}
##나쁜 답변:##
{{
  "legal_issue": "1. 구청이 너무 심하게 처분한 것 아닌가?\n2. 김철수는 카페 영업을 계속할 수 있는가?\n3. 직원이 모자 안 쓴 게 그렇게 큰 잘못인가?"
}}
##👎 이유:##
- 쟁점의 비전문성 및 주관성: '구청이 너무 심하게 처분한 것 아닌가?'는 의뢰인의 주관적인 의견이나 감정이거나, 법률 전문가의 논리적 질문이 아닌 일반인의 단순한 의문에 가까워요. 법적 쟁점은 법률적 판단 기준에 근거한 질문이어야 하죠.
- 해결책/결과 예측: '김철수는 카페 영업을 계속할 수 있는가?'는 사건의 최종 결과나 해결책에 대한 질문으로, 법률적 판단이 필요한 쟁점 자체가 아니에요.
- 행정법적 관점 부족: '직원이 모자 안 쓴 게 그렇게 큰 잘못인가?'는 단순히 행위의 경중에 대한 질문일 뿐, 그 행위가 어떤 법규(식품위생법 제75조)를 위반했는지, 그리고 그 위반이 처분의 정당한 사유가 되는지에 대한 행정법적 쟁점을 담아내지 못하고 있어요.
##좋은 답변:##
{{
  "legal_issue": "1. A구청의 영업정지 처분이 절차적 하자를 가지고 있는가?\n2. A구청의 영업정지 처분이 '식품위생법 제75조 위반' 사실을 오인하여 위법한가?\n3. A구청의 영업정지 처분이 위반행위에 비해 과도하여 비례의 원칙에 위배되는 재량권 일탈 또는 남용에 해당하는가?"
}}
##👍 이유:##
- 절차적 위법성 쟁점화: '영업정지 처분이 절차적 하자를 가지고 있는가?'는 행정소송에서 매우 중요한 처분 과정의 적법성을 묻는 쟁점이에요. 예를 들어, 처분 전 청문 절차 누락 등이 여기에 해당할 수 있죠.
- 내용상 위법성 쟁점화 (사실 오인): '식품위생법 제75조 위반' 사실을 오인하여 위법한가?'는 처분의 근거가 된 사실 자체가 잘못된 것인지를 다루는 쟁점이에요. 행정청이 사실을 오인했을 경우 처분은 위법하게 되죠.
- 재량권 일탈/남용 쟁점화 (비례의 원칙): '위반행위에 비해 과도하여 비례의 원칙에 위배되는 재량권 일탈 또는 남용에 해당하는가?'는 처분의 내용이 공익과 사익 간의 균형을 잃었는지를 묻는 핵심적인 행정법상 쟁점이에요. 처분으로 인한 매출 손실 등 피해 내용을 바탕으로 판단됩니다.

##사건 내용:##
{{
  "basic_facts": [
    "1. 원고 박영희는 2023년 12월 20일 밤 11시경 서울 강남구 테헤란로에서 음주 상태로 차량을 운전하다 음주 단속에 적발되었다.",
    "2. 위 단속 당시 원고 박영희의 혈중알코올농도는 0.09%로 측정되었다.",
    "3. 경찰청은 2024년 1월 10일 원고 박영희에게 등기우편으로 운전면허 취소 처분 통지서를 발송하였다.",
    "4. 원고 박영희는 대리운전을 주 수입원으로 하는 프리랜서이며, 운전면허 취소로 인해 월 약 300만 원의 수입 손실이 발생하고 있다."
  ]
}}
##나쁜 답변:##
{{
  "legal_issues": "1. 박영희 면허가 정말 취소되는 게 맞을까?\n2. 박영희는 이제 어떻게 돈을 벌지?\n3. 음주운전 처벌이 너무 강한 것 같다."
}}
##👎 이유:##
- 사실 관계의 재확인: '박영희 면허가 정말 취소되는 게 맞을까?'는 이미 통지서가 온 사실 관계를 다시 확인하는 것이며, 법률적 판단이 필요한 쟁점이 아니에요.
- 주관적 감정/해결책 제시: '박영희는 이제 어떻게 돈을 벌지?'는 의뢰인의 주관적인 우려나 향후 생활에 대한 질문이지, 행정청의 처분과 관련된 법적 쟁점이 아니에요. '음주운전 처벌이 너무 강한 것 같다'는 정책에 대한 의견으로, 특정 처분의 위법성을 다투는 법적 쟁점이 될 수 없죠.
##좋은 답변:##
{{
  "legal_issues": "1. 경찰청의 운전면허 취소 처분에 절차적 하자가 존재하는가?\n2. 원고 박영희의 혈중알코올농도 수치(0.09%)가 운전면허 취소 처분 기준에 해당하는가?\n3. 운전면허 취소 처분이 원고의 생계에 미치는 영향이 중대하여 재량권 일탈 또는 남용에 해당하는가?"
}}
##👍 이유:##
- 절차적 하자 쟁점화: '운전면허 취소 처분에 절차적 하자가 존재하는가?'는 처분 과정에서 법적 절차가 제대로 지켜졌는지를 묻는 쟁점이에요.
- 법규 위반 사실의 쟁점화: '혈중알코올농도 수치(0.09%)가 운전면허 취소 처분 기준에 해당하는가?'는 처분의 근거가 된 위법 사실(음주 수치)이 관련 법규(도로교통법)에 명시된 취소 기준을 실제로 충족하는지를 묻는 쟁점이에요. 이는 처분의 법률 적합성을 판단하는 핵심이죠.
- 재량권 일탈/남용 쟁점화 (비례의 원칙 및 중대한 피해): '생계에 미치는 영향이 중대하여 재량권 일탈 또는 남용에 해당하는가?'는 처분이 개인의 생계에 미치는 막대한 불이익(월 300만 원 수입 손실)을 고려했을 때 과도한 것인지를 묻는 쟁점이에요. 이는 처분으로 인한 피해 내용을 바탕으로 판단되는 중요한 행정법상 쟁점입니다.

##사건 내용:##
{{
  "basic_facts": [
    "1. 원고 이민호는 2024년 3월 5일 관할 세무서로부터 2023년 귀속 종합소득세 1천만 원 추가 납부 고지서를 수령하였다.",
    "2. 원고 이민호는 세무서가 자신의 2023년 사업 소득을 과다하게 계산하였다고 주장한다.",
    "3. 원고 이민호는 위 과세 처분에 대해 2024년 3월 15일 이의 신청을 제기하였다.",
    "4. 원고는 2024년 4월 20일 위 이의 신청이 '불채택'되었다는 결정 통지서를 수령하였다.",
    "5. 원고는 2024년 5월 10일 위 불채택 결정에 불복하여 행정심판을 청구하였다."
  ]
}}
##나쁜 답변:##
{{
  "legal_issues": "1. 세금 고지서가 잘못된 것 같다.\n2. 이의 신청했는데 왜 안 받아주지?\n3. 행정심판 하면 이길 수 있을까?"
}}
##👎 이유:##
- 쟁점의 모호성 및 일반화: '세금 고지서가 잘못된 것 같다'는 과세 처분 불복의 핵심 사유를 명확한 법률적 쟁점으로 제시하지 못했어요. 구체적으로 어떤 점에서 잘못된 것인지가 빠져있죠.
- 절차적 사실에 대한 의문 제기: '이의 신청했는데 왜 안 받아주지?'는 불복 절차의 결과에 대한 단순한 의문일 뿐, 그 결정이 법적으로 타당한지 묻는 쟁점이 아니에요.
- 결과 예측: '행정심판 하면 이길 수 있을까?'는 소송의 승소 가능성에 대한 예측으로, 법적 쟁점이 아닙니다.

##좋은 답변:##
{{
  "legal_issues": "1. 관할 세무서의 2023년 귀속 종합소득세 부과 처분이 원고의 소득을 과다하게 계산한 사실 오인에 해당하는가?\n2. 위 과세 처분에 절차적 하자가 존재하는가?\n3. 원고의 이의 신청 불채택 결정이 적법한가?\n4. 원고가 제기한 행정심판 청구가 적법한 소송 요건을 갖추었는가?"
}}
##👍 이유:##
- 사실 오인 쟁점화: '종합소득세 부과 처분이 원고의 소득을 과다하게 계산한 사실 오인에 해당하는가?'는 과세 처분 취소 소송에서 가장 흔하고 중요한 쟁점 중 하나인 사실 오인 여부를 직접적으로 묻습니다. 세무서의 판단이 실제 사실과 달랐는지가 핵심이죠.
- 절차적 하자 쟁점화: '위 과세 처분에 절차적 하자가 존재하는가?'는 과세 처분 과정에서 세법상 요구되는 절차(예: 과세예고 통지, 납세자 해명 기회 부여 등)가 지켜졌는지를 다루는 쟁점입니다.
- 불복 절차의 유효성 쟁점화: '원고의 이의 신청 불채택 결정이 적법한가?'는 행정청의 중간 단계 결정(이의 신청 결과) 자체의 적법성을 묻는 중요한 쟁점이에요. 불복 절차의 하자 여부가 최종 행정소송에 영향을 미칠 수 있습니다.
- 소송 요건 쟁점화: '원고가 제기한 행정심판 청구가 적법한 소송 요건을 갖추었는가?'는 행정심판 또는 향후 행정소송 제기 시 법원이 가장 먼저 심리할 소송 요건 충족 여부를 쟁점화하여, 소송 가능성을 판단하는 데 필수적인 질문입니다.
            """
        },
        {
            "role": "user",
            "content": f"""## 기초 사실
{facts_str}

## 사건 설명
{description}"""
        }
    ]

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.3,
            response_format={"type": "json_object"}
        )
        raw = response.choices[0].message.content
        parsed = json.loads(raw)
        return parsed.get("legal_issues", "")
    except Exception as e:
        print("❌ 오류 발생:", e)
        return ""
