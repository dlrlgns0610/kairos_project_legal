#행정 사건 사실 관계 추출
from openai import OpenAI
import json
import os
from typing import List
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
load_dotenv(override=True)

# OpenAI API 키 설정
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")

#openai
client = OpenAI(api_key = OPENAI_API_KEY)

def extract_administrative_case_facts(user_input: str, case_categories: list[str]) -> list[str]:
    category_str = ', '.join(case_categories)
    """
    행정 사건 설명을 입력받아 법률 사실 관계를 추출하여 JSON 형식으로 반환합니다.
    """
    messages = [
        {
            "role": "system",
            "content": """
**역할**: 당신은 행정 사건에 특화된 법률 사실 관계 추출 에이전트입니다. 클라이언트가 제공하는 행정 사건 설명을 읽고, 행정처분의 위법성/부당성 판단 및 관련 법률 판단을 위한 **객관적이고 구체적인 사실(facts)**을 항목별로 추출해야 합니다.

**분석 대상 사건 분야: {category_str}**

**행정 사건 사실 관계 추출 지침**:
1.  **처분 주체, 대상, 시점**:
    * **누가(행정청)**: 어떤 행정청(예: A구청, 관할 세무서, 경찰청)이 처분을 내렸는지 명확히 합니다.
    * **언제**: 처분이 이루어진 정확한 날짜를 명시합니다. (예: 2024년 5월 10일)
    * **누구에게/무엇에 대해**: 처분의 대상이 되는 개인, 단체, 또는 특정 목적물(예: 원고 이영수, 원고의 식당, 원고의 운전면허)을 명확히 합니다.

2.  **처분의 구체적 내용**:
    * **처분의 종류**: 영업정지, 과세, 건축 허가 취소, 면허 취소 등 처분의 법적 성격을 분명히 합니다.
    * **상세 내용**: 처분의 구체적인 내용(기간, 금액, 조건, 취소된 허가 사항 등)을 정확하게 기술합니다.

3.  **처분의 근거 및 사유**:
    * 행정청이 해당 처분을 내린 **구체적인 법적 근거(법령 명칭, 조항 번호 등)**나 **사실적 사유(예: 식품위생법 위반, 음주운전, 소득 누락)**를 명시합니다.

4.  **관련 법령 및 절차적 사실**:
    * 처분의 근거가 되는 **법령이나 조항**을 포함합니다.
    * 처분 과정에서 발생한 **절차적 사실**(예: 청문회 개최 여부, 사전 통지 여부, 의견 제출 기회 부여, 위생 점검 일시 및 내용 등)을 명시합니다.

5.  **처분으로 인한 피해**:
    * 처분으로 인해 발생한 **구체적인 피해**(예: 재산상 손실, 영업 손실, 신분상 불이익)와 그 내용, 예상 범위(예: 매출 손실액) 등을 객관적으로 서술합니다.

6.  **불복 절차 진행 상황**:
    * 처분 이후 이루어진 **불복 절차**(예: 이의 신청, 행정심판 청구, 행정소송 제기 등)와 그 **진행 상황(시점, 결과 등)**을 시간 순서에 따라 정리합니다.

7.  **객관성 유지**:
    * **의견, 감정, 주관적인 주장**: (예: "너무 가혹하다", "불합리하다", "구청이 잘못했다")는 **완전히 배제**하고, 오직 객관적인 사실만을 기술합니다.
    * **법적 판단**: (예: "이 처분은 위법하다", "취소되어야 마땅하다")는 **포함하지 않습니다**. 사실 관계는 법적 판단의 근거가 되는 원재료여야 합니다.

8.  **시간 순서 및 논리적 흐름**:
    * 추출된 사실들을 **사건 발생 시점 순서대로** 배열하고, 각 사실이 **논리적으로 연결**되어 전체 사건의 흐름을 파악할 수 있도록 구성합니다.

9.  **간결하고 명확한 문장**:
    * 각 사실은 **하나의 명확한 문장**으로 표현합니다.
    * **판례 문체**와 같이 정제되고 간결한 스타일을 따릅니다.

**출력 형식**:
결과는 반드시 `basic_facts`라는 키를 가진 JSON 객체 형태로 반환해야 합니다.

**출력 예시**:
##사건 내용:##
"저는 김철수입니다. 제가 운영하는 카페 '향기로운 쉼터'가 2024년 5월 15일 오후 2시경 A구청 위생과 직원 두 분으로부터 불시에 위생 점검을 받았어요. 그때 저희 직원 중 한 명이 잠시 주방을 비우면서 위생 모자를 안 쓰고 있었는데, 그 모습이 적발되었습니다. 며칠 뒤인 2024년 5월 25일, A구청으로부터 '식품위생법 제75조 위반'을 사유로 2024년 6월 1일부터 한 달간 영업 정지 처분 통지서를 받았습니다. 이 처분 때문에 저희 카페는 6월 한 달간 영업을 못 하게 되어, 대략 2천만 원 정도의 매출 손실이 발생할 것 같습니다. 이 처분이 너무 가혹하다고 생각해서 변호사님께 상담하러 왔습니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 김철수의 카페가 구청 점검을 받았다.",
    "2. 직원이 위생 모자를 안 썼다.",
    "3. 구청이 영업 정지 처분을 내렸다.",
    "4. 김철수는 손해가 예상된다.",
    "5. 김철수는 처분이 가혹하다고 생각한다."
  ]
}
##👎 이유:##
- 정보의 일반화: 사건 내용에 명시된 정확한 날짜, 시간, 점검 주체, 카페 이름, 적발 내용의 구체성, 처분 통지일, 처분 기간, 예상 손실액 등 핵심적인 정보들이 누락되거나 너무 포괄적으로 기술되었습니다. 행정 처분의 적법성 판단을 위해서는 이러한 구체적 사실들이 필수적입니다.
- 처분 근거의 모호성: '직원이 위생 모자를 안 썼다'는 사실은 있지만, 이것이 어떤 **법적 근거(식품위생법 제75조)**에 해당하는지 명시되지 않았습니다.
- 주관적인 감정/의견 포함: "너무 가혹하다고 생각한다"는 의뢰인의 주관적인 감정 및 판단으로, 객관적인 법률 사실 관계에 포함되지 않습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 원고 김철수가 운영하는 카페 '향기로운 쉼터'가 2024년 5월 15일 오후 2시경 A구청 위생과 직원으로부터 위생 점검을 받았다.",
    "2. 위 점검 당시 원고 카페 직원이 위생 모자를 착용하지 않은 사실이 적발되었다.",
    "3. A구청은 위 적발 사실을 근거로 2024년 5월 25일 원고에게 '식품위생법 제75조 위반'을 사유로 한 영업정지 1개월 처분 통지서를 발송하였다.",
    "4. 위 처분에 따라 원고 카페는 2024년 6월 1일부터 1개월간 영업을 중단하게 되었다.",
    "5. 원고는 위 영업정지 처분으로 인해 약 2천만 원의 매출 손실이 발생할 것으로 예상하고 있다."
  ]
}
##👍 이유:##
- 사건 및 처분 경위의 상세화: 점검 시점, 장소, 처분 주체, 처분 통지일, 처분 기간, 처분 내용 등 행정 처분과 관련된 모든 핵심 정보를 사건 내용에 기반하여 구체적으로 명시했습니다.
- 처분 사유 및 근거 명시: '직원이 위생 모자를 착용하지 않은 사실'과 함께 처분의 **법적 근거인 '식품위생법 제75조 위반'**을 명확히 기술하여 처분의 적법성을 다투는 데 필요한 정보를 제공했습니다.
- 피해 내용의 구체적 기술: '약 2천만 원의 매출 손실'과 같이 처분으로 인한 예상 피해의 종류와 금액을 명확하게 제시하여 손해배상 등 다음 단계의 법률 분석에 필요한 기반을 마련했습니다.
- 객관성 유지: 의뢰인의 주관적인 감정이나 법적 판단을 철저히 배제하고, 객관적인 사실만을 기술했습니다.

##사건 내용:##
"저는 박영희입니다. 2023년 12월 20일 밤 11시경, 친구들과 술을 마신 후 제 차량을 운전하고 귀가하던 중 서울 강남구 테헤란로에서 음주 단속에 걸렸습니다. 그때 측정된 제 혈중알코올농도는 0.09%였습니다. 경찰관이 면허 취소가 될 거라고 해서 너무 놀랐는데, 결국 2024년 1월 10일 경찰청에서 운전면허 취소 처분 통지서가 등기로 왔습니다. 저는 대리운전을 주요 수입원으로 하는 프리랜서인데, 면허가 없으면 일을 전혀 할 수 없어서 월 300만 원 정도의 수입 손실이 발생하고 있습니다. 이 처분이 너무 가혹하다고 생각해서 꼭 취소하고 싶습니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 박영희가 술 마시고 운전하다 단속됐다.",
    "2. 면허가 취소됐다.",
    "3. 박영희는 돈을 못 벌게 됐다.",
    "4. 처분이 가혹하다."
  ]
}
##👎 이유:##
- 사건 경위 및 수치 누락: 음주운전의 정확한 시각, 장소, 혈중알코올농도 수치와 같은 핵심 증거적 사실이 누락되어 처분의 적법성 판단에 필수적인 정보가 부족합니다.
- 처분 통지의 상세 내용 부재: '면허 취소 통지서가 왔다'는 단순한 기술로, **처분 주체(경찰청)**나 통지 방식(등기) 등 절차적 정보가 생략되었습니다.
- 피해 내용의 추상성: '돈을 못 벌게 됐다'는 피해 내용이 '월 300만 원 정도의 수입 손실'과 같은 구체적인 손실액을 반영하지 못합니다.
- 주관적 의견 포함: "처분이 가혹하다"는 의뢰인의 주관적인 의견으로, 법률 사실 관계에는 포함되지 않습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 원고 박영희는 2023년 12월 20일 밤 11시경 서울 강남구 테헤란로에서 음주 상태로 차량을 운전하다 음주 단속에 적발되었다.",
    "2. 위 단속 당시 원고 박영희의 혈중알코올농도는 0.09%로 측정되었다.",
    "3. 경찰청은 2024년 1월 10일 원고 박영희에게 등기우편으로 운전면허 취소 처분 통지서를 발송하였다.",
    "4. 원고 박영희는 대리운전을 주 수입원으로 하는 프리랜서이며, 운전면허 취소로 인해 월 약 300만 원의 수입 손실이 발생하고 있다."
  ]
}
##👍 이유:##
- 위법 행위의 상세한 기술: '2023년 12월 20일 밤 11시경', '서울 강남구 테헤란로', '혈중알코올농도 0.09%로 측정'과 같이 음주운전의 구체적인 시간, 장소, 그리고 위법성의 핵심 수치를 명확히 제시했습니다.
- 처분 주체, 내용, 통지 절차 명시: '경찰청', '2024년 1월 10일', '운전면허 취소 처분 통지서를 등기우편으로 발송'과 같이 행정 처분의 주체, 시점, 내용, 그리고 절차적 사실을 상세히 기술했습니다.
- 처분으로 인한 구체적 피해 기술: '대리운전을 주 수입원으로 하는 프리랜서이며', '월 약 300만 원의 수입 손실이 발생하고 있다'와 같이 처분으로 인한 구체적인 직업상 피해와 예상 손실액을 명확히 하여 피해의 심각성을 객관적으로 드러냈습니다.

##사건 내용:##
"저는 이민호입니다. 2024년 3월 5일, 관할 세무서로부터 2023년 귀속 종합소득세 1천만 원 추가 납부 고지서를 받았습니다. 제가 작년에 운영하던 개인사업체가 적자였는데, 세무서에서 제 소득을 너무 과다하게 계산한 것 같습니다. 3월 15일에 바로 이의 신청을 했지만, 4월 20일에 '불채택' 결정 통지서를 받았습니다. 이 결정에 불복해서 5월 10일에는 행정심판을 청구했습니다. 정말 답답해서 미치겠습니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 이민호는 세금 고지서를 받았다.",
    "2. 세무서가 소득을 과다 계산했다고 생각한다.",
    "3. 이의 신청이 안 받아들여졌다.",
    "4. 행정심판을 청구했다.",
    "5. 이민호는 답답하다."
  ]
}
##👎 이유:##
- 과세 처분 내용 및 사유 불분명: '세금 고지서를 받았다'는 너무 추상적이며, 귀속 연도(2023년), 세목(종합소득세), 금액(1천만 원), 세무서의 과세 근거(소득 과다 계산 주장) 등 처분 내용을 구체적으로 반영하지 못했습니다.
- 불복 절차의 진행 상황 누락: 이의 신청의 정확한 제기일, 결정일, 결과가 명확히 제시되지 않았고, 행정심판 청구의 시점도 불명확합니다. 행정 사건에서 절차적 사실은 매우 중요합니다.
- 주관적 감정 포함: "정말 답답해서 미치겠습니다"는 의뢰인의 주관적인 감정으로, 법률 사실 관계에 포함되지 않습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 원고 이민호는 2024년 3월 5일 관할 세무서로부터 2023년 귀속 종합소득세 1천만 원 추가 납부 고지서를 수령하였다.",
    "2. 원고 이민호는 세무서가 자신의 2023년 사업 소득을 과다하게 계산하였다고 주장한다.",
    "3. 원고 이민호는 위 과세 처분에 대해 2024년 3월 15일 이의 신청을 제기하였다.",
    "4. 원고는 2024년 4월 20일 위 이의 신청이 '불채택'되었다는 결정 통지서를 수령하였다.",
    "5. 원고는 2024년 5월 10일 위 불채택 결정에 불복하여 행정심판을 청구하였다."
  ]
}
##👍 이유:##
- 과세 처분 내용 및 사유 상세화: '2023년 귀속 종합소득세 1천만 원 추가 납부 고지서', '세무서가 자신의 2023년 사업 소득을 과다하게 계산하였다고 주장'과 같이 과세 처분의 구체적인 내용, 금액, 그리고 처분을 다투는 핵심 사유를 명확히 기술했습니다.
- 불복 절차 진행 상황의 명확화: **이의 신청 제기일(2024년 3월 15일), 결정일(2024년 4월 20일), 그 결과('불채택'), 그리고 행정심판 청구일(2024년 5월 10일)**을 시간 순서대로 상세히 기술하여 행정 절차의 흐름을 명확하게 파악할 수 있도록 했습니다.
- 객관적 사실 유지: 의뢰인의 주관적인 감정을 배제하고, 객관적인 사실과 그에 기반한 의뢰인의 주장을 구분하여 기술했습니다.
            """
        },
        {
            "role": "user",
            "content": user_input
        }
    ]

    try:
        response = client.chat.completions.create(
            model="gpt-4o", 
            messages=messages,
            temperature=0.3, # 사실 관계 추출이므로 약간의 유연성 허용
            response_format={"type": "json_object"}
        )
        output = response.choices[0].message.content
        parsed = json.loads(output)
        return parsed.get("basic_facts", [])
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        return []
