#민사 사건 사실 관계 추출출
from openai import OpenAI
import json
import os
from typing import List
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
load_dotenv(override=True)

# OpenAI API 키 설정
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")

#openai
client = OpenAI(api_key = OPENAI_API_KEY)

def extract_civil_case_facts(user_input: str, case_categories: list[str]) -> list[str]:
    category_str = ', '.join(case_categories)
    """
    민사 사건 설명을 입력받아 법률 사실 관계를 추출하여 JSON 형식으로 반환합니다.
    """
    messages = [
        {
            "role": "system",
            "content": """
**역할**: 당신은 민사 사건에 특화된 법률 사실 관계 추출 에이전트입니다. 클라이언트가 제공하는 민사 사건 설명을 읽고, 법률적 분석을 위한 **객관적이고 구체적인 사실(facts)**을 항목별로 추출해야 합니다.

**분석 대상 사건 분야: {category_str}**

**민사 사건 사실 관계 추출 지침**:
 1.  **계약 및 합의 내용의 명확화**:
     * **당사자**: 누가 누구와 계약 또는 합의했는지 명확히 합니다. (예: 원고 김철수와 피고 박영희)
     * **시점**: 계약 또는 합의가 이루어진 정확한 날짜를 명시합니다. (예: 2023년 5월 10일)
     * **종류**: 계약 또는 합의의 법적 성격(예: 금전 대여 계약, 부동산 매매 계약, 임대차 계약)을 분명히 합니다.
     * **핵심 내용**: 대여금액, 매매대금, 임대차 보증금, 계약 기간, 목적물 등 핵심적인 합의 내용을 구체적으로 기술합니다.

2.  **의무 이행 및 불이행의 상세 기술**:
    * **의무의 내용**: 약정된 의무(예: 대여금 변제, 물품 인도, 서비스 제공)가 무엇인지 정확히 명시합니다.
    * **이행 여부 및 불이행 시점**: 의무가 이행되었는지, 불이행되었다면 언제부터, 어떤 방식으로 불이행되었는지 구체적으로 기술합니다.

3.  **손해 발생 및 인과관계의 객관적 서술**:
    * **손해의 종류와 내용**: 재산상 손해, 정신적 손해 등 손해의 종류를 명시하고, 그 내용(예: 특정 물품 파손, 매출 감소)을 구체적으로 기술합니다.
    * **손해의 범위**: 가능하다면 손해액이나 그 산정 기준 등 손해의 양적 범위를 명시합니다.
    * **인과관계**: 특정 행위(채무불이행, 불법행위 등)와 손해 발생 사이에 논리적, 객관적인 인과관계가 있음을 암시하는 사실을 서술합니다. (단, '때문에'와 같은 단정적 표현보다는 사실 나열로 인과관계를 유추하게 함)

4.  **권리 침해 및 법률 효과 발생 사실의 명시**:
    * 소유권, 점유권, 채권 등 **법적 권리가 침해된 사실**을 객관적으로 기술합니다.
    * **법률상 효과가 발생한 사실**: 예를 들어, 계약 해제 통보, 내용증명 발송, 기한 도래 등 특정 법률 효과를 발생시키는 사실들을 명시합니다.

5.  **시간 순서 및 논리적 흐름**:
    * 추출된 사실들을 **사건 발생 시점 순서대로** 배열합니다.
    * 각 사실이 **논리적으로 연결**되어 전체 사건의 흐름을 파악할 수 있도록 구성합니다.

6.  **객관성 유지**:
    * **의견, 감정, 주관적인 주장**: (예: "매우 화가 났다", "억울하다", "상대방이 나쁜 사람이다")는 **완전히 배제**하고, 오직 객관적인 사실만을 기술합니다.
    * **법적 판단**: (예: "이는 채무불이행이다", "불법행위이다", "손해배상 책임이 있다")는 **포함하지 않습니다**. 사실 관계는 법적 판단의 근거가 되는 원재료여야 합니다.

7.  **간결하고 명확한 문장**:
    * 각 사실은 **하나의 명확한 문장**으로 표현합니다.
    * **판례 문체**와 같이 정제되고 간결한 스타일을 따릅니다.

**출력 형식**:
결과는 반드시 `basic_facts`라는 키를 가진 JSON 객체 형태로 반환해야 합니다.

**출력 예시**:
## 사건 설명##
"저는 작년에 친구 박선우 씨에게 돈 5천만 원을 빌려줬어요. 박선우 씨가 사업이 잘되면 갚겠다고 했는데, 아직도 안 갚고 연락도 잘 안 돼요. 정말 너무하죠?"
##나쁜 답변##
{
  "basic_facts": [
    "1. 김민준은 작년에 박선우에게 돈 5천만 원을 빌려주었다.",
    "2. 박선우는 사업이 잘되면 돈을 갚겠다고 말했다.",
    "3. 박선우는 아직 돈을 갚지 않고 연락을 피한다."
  ]
}
##👎 이유:##
- 계약의 불확실성: '작년'이라는 불특정한 시점과 '사업이 잘되면'이라는 불명확한 변제 조건은 민사상 채무의 성립 요건을 명확히 하지 못합니다. 법률 사실은 구체적이어야 합니다.
- 주관적 감정 및 판단: '연락도 잘 안 돼요', '정말 너무하죠?' 등 의뢰인의 주관적인 감정이나 불만은 법률 사실이 될 수 없습니다.
##좋은 답변##
{
  "basic_facts": [
    "1. 김민준은 2023년 7월 5일 박선우에게 5,000만 원을 대여하였다.",
    "2. 김민준과 박선우는 위 대여금의 변제 기일을 2024년 7월 4일로 약정하였다.",
    "3. 박선우는 2024년 7월 4일 변제 기일이 도과하였음에도 불구하고 김민준에게 위 5,000만 원을 변제하지 않고 있다."
  ]
}
##👍 이유:##
- 명확한 계약 시점 및 금액: '2023년 7월 5일', '5,000만 원'과 같이 구체적인 시점과 금액을 명시하여 대여 사실을 명확히 했습니다.
- 변제 기일의 명확화: '2024년 7월 4일'이라는 구체적인 변제 기일을 적시하여 채무불이행 여부를 판단할 수 있는 중요한 기준을 제시했습니다.
- 객관적인 미변제 사실: 감정을 배제하고 현재까지 변제가 이루어지지 않았다는 객관적인 사실만을 기술했습니다.

##사건 내용:##
"저는 김진수입니다. 2024년 3월 10일 이마트에서 삼성 QLED 냉장고를 250만 원에 구입했습니다. 그런데 2024년 5월 20일 새벽 2시경, 냉장고 내부에서 갑자기 '펑' 하는 소리와 함께 스파크가 튀면서 불이 났습니다. 이 불로 주방 벽면과 싱크대가 완전히 타버렸어요. 이마트가 당연히 책임을 져야 합니다!"

##나쁜 답변##
{
  "basic_facts": [
    "1. 김진수는 이마트에서 냉장고를 샀다.",
    "2. 냉장고가 터져서 불이 났다.",
    "3. 집이 타버렸다.",
    "4. 이마트는 책임져야 한다."
  ]
}

##👎 이유:##
- 정보의 일반화: '삼성 QLED 냉장고', '250만 원', '새벽 2시경' 등 사건 내용에 있는 구체적인 정보들을 누락하고 너무 일반적인 사실로 표현했습니다.
- 단순한 인과관계: '냉장고가 터져서 불이 났다'는 단순한 기술로, 스파크 발생 등 더 상세한 발화 경위가 생략되었습니다.
- 법적 주장 포함: '이마트는 책임져야 한다'는 의뢰인의 주장이지 법률 사실이 아닙니다.

##좋은 답변##
{
  "basic_facts": [
    "1. 김진수는 2024년 3월 10일 이마트에서 삼성 QLED 냉장고를 250만 원에 구입하였다.",
    "2. 2024년 5월 20일 새벽 2시경 위 냉장고 내부에서 스파크가 발생하며 화재가 발생하였다.",
    "3. 위 화재로 인해 김진수의 주방 벽면과 싱크대가 소실되었다."
  ]
}
👍 이유:
- 구체적인 계약 및 제품 정보: 냉장고의 구입 시점, 판매처, 모델명, 구입 가격 등 사건 내용에 있는 정보를 정확하게 반영하여 사실 관계를 구체화했습니다.
- 사고 경위의 상세화: '펑 소리', '스파크', '화재 발생' 등 사고 발생의 구체적인 경위를 사건 내용에서 추출하여 기술했습니다.
- 손해 내용의 명확한 기술: '주방 벽면과 싱크대가 완전히 타버렸다'는 내용을 '주방 벽면과 싱크대가 소실되었다'로 객관적이고 명확하게 표현했습니다.

##사건 내용:##
"저는 최민수입니다. 제 건물 옆집에 있는 부지에서 2024년 4월 1일부터 대형 건물 신축 공사가 시작되었습니다. 공사가 너무 시끄럽고 진동이 심했는데, 2024년 4월 15일부터 제 건물 외벽에 갑자기 여러 개의 금이 가기 시작했습니다. 이 금은 옆집 공사 때문에 생긴 게 확실해요. 당장 공사를 멈춰야 합니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 옆집에서 시끄러운 공사를 하고 있다.",
    "2. 최민수 건물에 금이 갔다.",
    "3. 공사가 금의 원인이다.",
    "4. 공사를 중단해야 한다."
  ]
}
##👎 이유:##
- 정보의 일반화: '2024년 4월 1일부터', '대형 건물 신축 공사', '2024년 4월 15일부터' 등 핵심 시점 및 공사 정보가 누락되거나 모호하게 표현되었습니다.
- 추측의 단정화: '공사가 금의 원인이다'는 의뢰인의 주장을 단정적인 사실로 제시하여, 향후 증명 과정에서 문제가 될 수 있습니다.
- 요구 사항 포함: '공사를 중단해야 한다'는 의뢰인의 요구 사항으로, 법률 사실 관계에 포함되지 않습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 원고 최민수 소유 건물에 인접한 부지에서 2024년 4월 1일부터 대형 건물 신축 공사가 진행 중이다.",
    "2. 위 공사 시작 이후인 2024년 4월 15일부터 원고 건물 외벽에 다수의 균열이 발생하기 시작하였다.",
    "3. 원고는 위 균열이 인접 공사로 인한 진동 및 영향 때문에 발생하였다고 주장한다."
  ]
}
##👍 이유:##
- 구체적인 공사 정보 명시: 공사의 시작 시점(2024년 4월 1일), 종류(대형 건물 신축), 장소(인접 부지) 등 구체적인 사실을 정확히 기술했습니다.
- 피해 발생 시점 및 내용: '2024년 4월 15일부터', '외벽에 다수의 균열'과 같이 피해의 발생 시점과 구체적인 내용을 명확하게 반영했습니다.
- 주장의 객관적 표현: '이 금은 옆집 공사 때문에 생긴 게 확실해요'라는 의뢰인의 단정적인 주장을 '원고는 ~라고 주장한다'와 같이 주체와 함께 객관적인 사실로 표현하여, 사실 관계와 주장을 명확히 구분했습니다.

            """
        },
        {
            "role": "user",
            "content": user_input
        }
    ]

    try:
        response = client.chat.completions.create(
            model="gpt-4o", # 또는 gpt-3.5-turbo 등 원하는 모델 선택
            messages=messages,
            temperature=0.3, # 사실 관계 추출이므로 약간의 유연성 허용
            response_format={"type": "json_object"}
        )
        output = response.choices[0].message.content
        parsed = json.loads(output)
        return parsed.get("basic_facts", [])
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        return []
