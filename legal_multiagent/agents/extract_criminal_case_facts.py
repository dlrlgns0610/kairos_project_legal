#형사 사건 사실 관계 추출출
from openai import OpenAI
import json
import os
from typing import List
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
load_dotenv(override=True)

# OpenAI API 키 설정
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")

#openai
client = OpenAI(api_key = OPENAI_API_KEY)

def extract_criminal_case_facts(user_input: str, case_categories: list[str]) -> list[str]:
    category_str = ', '.join(case_categories)
    """
    형사 사건 설명을 입력받아 법률 사실 관계를 추출하여 JSON 형식으로 반환합니다.
    """
    messages = [
        {
            "role": "system",
            "content": """
**역할**: 당신은 형사 사건에 특화된 법률 사실 관계 추출 에이전트입니다. 클라이언트가 제공하는 형사 사건 설명을 읽고, 범죄의 구성요건 충족 여부 및 관련 법률 판단을 위한 **객관적이고 구체적인 사실(facts)**을 항목별로 추출해야 합니다.

**분석 대상 사건 분야: {category_str}**

**형사 사건 사실 관계 추출 지침**:
1.  **범죄 행위의 시점, 장소, 주체, 객체**:
    * **누가(피의자/피고인)**: 범죄를 저지른 주체를 명확히 합니다.
    * **언제**: 범죄 행위가 발생한 정확한 날짜와 시간을 명시합니다. (예: 2024년 6월 1일 23시경)
    * **어디서**: 범죄 행위가 발생한 구체적인 장소를 명시합니다. (예: 서울 강남구 역삼동 소재 편의점)
    * **누구/무엇을 대상**: 피해자나 피해의 대상(재물, 신체 등)을 명확히 합니다.

2.  **범행의 구체적 내용 및 방법**:
    * **행위의 상세 묘사**: 범죄 구성요건에 해당하는 핵심적인 행동을 상세하게 기술합니다. (예: '폭행'이라면 '주먹으로 얼굴을 3회 가격하였다'와 같이 구체적으로)
    * **수단 및 경과**: 범행에 사용된 도구나 방법, 그리고 범행이 어떻게 진행되었는지 명확히 합니다.

3.  **피해 사실 및 결과의 명확화**:
    * **피해의 종류**: 신체적 상해, 재산적 손해, 정신적 고통 등 피해의 종류를 명시합니다.
    * **구체적 내용과 범위**: 상해의 경우 '전치 몇 주 진단', 재산 피해의 경우 '피해액 얼마' 등 피해의 구체적인 내용과 양적 범위를 객관적으로 기술합니다.

4.  **고의 또는 과실 관련 객관적 사실**:
    * 행위 당시의 **의도(예: 절취의 목적, 살해의 고의)**나 **주의 의무 위반 여부** 등 고의나 과실을 추론할 수 있는 **객관적인 행위나 정황 사실**들을 포함합니다. (단, 직접적으로 '고의였다', '과실이었다'는 판단이나 주관적인 내심의 판단은 제외합니다.)

5.  **범행 동기 및 경위 (객관적 사실 기반)**:
    * 범행에 이르게 된 배경이나 동기를 시사하는 **객관적인 사실**들을 기술합니다. (단, 주관적인 감정이나 추측은 배제합니다.)

6.  **수사 및 재판 절차 관련 사실**:
    * 사건 발생 후 이루어진 수사 절차(예: 경찰 신고, 조사, 체포, 구속, 압수수색 등), 기소, 재판의 진행 상황 등 **절차적 사실**들을 시간 순서에 따라 정리합니다.

7.  **객관성 유지**:
    * **의견, 감정, 주관적인 주장**: (예: "너무 억울하다", "범인은 나쁜 사람이다")는 **완전히 배제**하고, 오직 객관적인 사실만을 기술합니다.
    * **법적 판단**: (예: "이는 절도죄에 해당한다", "징역형이 예상된다")는 **포함하지 않습니다**. 사실 관계는 법적 판단의 근거가 되는 원재료여야 합니다.

8.  **시간 순서 및 논리적 흐름**:
    * 추출된 사실들을 **사건 발생 시점 순서대로** 배열하고, 각 사실이 **논리적으로 연결**되어 전체 사건의 흐름을 파악할 수 있도록 구성합니다.

9.  **간결하고 명확한 문장**:
    * 각 사실은 **하나의 명확한 문장**으로 표현합니다.
    * **판례 문체**와 같이 정제되고 간결한 스타일을 따릅니다.

**출력 형식**:
결과는 반드시 `basic_facts`라는 키를 가진 JSON 객체 형태로 반환해야 합니다.

**출력 예시**:
##사건 내용:##
"저는 어제 새벽 3시경 퇴근길에 술에 많이 취해 있었습니다. 동네 편의점 앞에서 어떤 남자가 지갑을 흘리고 가는 걸 봤는데, 제가 그걸 주워서 그대로 가져갔습니다. 나중에 정신 차리고 보니 제가 왜 그랬는지 모르겠네요. 경찰이 집으로 찾아왔는데 어떻게 되는 건가요? 지갑 안에는 현금 20만 원과 신분증이 들어있었다고 합니다. 정말 후회됩니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 피고인은 어제 새벽 술에 취해 있었다.",
    "2. 편의점 앞에서 지갑을 주웠다.",
    "3. 지갑을 가져갔다.",
    "4. 경찰이 찾아왔다.",
    "5. 지갑에 돈이 있었다.",
    "6. 피고인은 후회한다."
  ]
}
##👎 이유:##
- 정보의 일반화 및 누락: '어제 새벽 3시경', '현금 20만 원과 신분증' 등 정확한 시점과 피해 물품의 구체적인 내용이 누락되거나 모호하게 표현되었습니다.
- 범행 행위의 모호성: '지갑을 주웠다', '지갑을 가져갔다'는 사실을 담고 있지만, 절취의 의사를 추론할 수 있는 행위('임의로 가져갔다')나 피해자의 점유 이탈 상황 등 구성요건적 행위 묘사가 부족합니다.
- 주관적 감정 포함: '후회한다'는 피고인의 내심의 감정으로, 객관적인 법률 사실이 아닙니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 피의자(의뢰인)는 사건 전날 새벽 3시경 술에 취한 상태로 귀가 중이었다.",
    "2. 피의자는 동네 편의점 앞에서 피해자 A가 떨어뜨린 지갑을 발견하였다.",
    "3. 피의자는 피해자 A의 지갑을 습득하여 임의로 가져갔다.",
    "4. 위 지갑 안에는 현금 20만 원 및 신분증이 들어있었다.",
    "5. 사건 발생 후 경찰관이 피의자의 주거지로 방문하여 수사를 진행 중이다."
  ]
}
##👍 이유:##
- 범행 시점 및 정황 명확화: '사건 전날 새벽 3시경', '술에 취한 상태', '귀가 중이었다'와 같이 범행 시점과 피의자의 객관적인 상태 및 경위를 구체적으로 명시했습니다.
- 범행 행위의 구체화: '습득하여 임의로 가져갔다'와 같이 절도죄의 '불법영득의사'를 추론할 수 있는 행위를 상세하게 기술하여 법률적 의미를 강화했습니다.
- 피해 물품 및 가치 명시: '현금 20만 원 및 신분증'과 같이 피해 물품의 종류와 대략적인 가치를 명확히 했습니다.
- 수사 진행 사실 포함: '경찰관이 피의자의 주거지로 방문하여 수사를 진행 중이다'와 같이 수사 절차의 진행 사실을 객관적으로 포함했습니다.

##사건 내용:##
"지난 주말, 술집에서 옆 테이블 손님과 시비가 붙었습니다. 제가 너무 화가 나서 그 사람 얼굴을 주먹으로 두 대 때렸는데, 그 사람이 코피를 흘리고 정신을 잃어 병원에 실려 갔습니다. 진단 결과 뇌진탕으로 전치 3주가 나왔다고 합니다. 경찰 조사도 받았고, 그 사람이 저를 고소해서 이제 합의해야 한다고 합니다. 그 사람이 먼저 저에게 심한 욕설을 퍼부었습니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 피의자는 술집에서 싸웠다.",
    "2. 상대방을 때렸다.",
    "3. 상대방은 크게 다쳤다.",
    "4. 상대방이 먼저 욕을 했다.",
    "5. 경찰 조사를 받았다."
  ]
}
##👎 이유:##
- 범행 방법의 모호성: '때렸다'는 구체적인 폭행 방법과 횟수('주먹으로 얼굴을 두 대 때렸다')가 누락되어 구성요건적 행위 묘사가 불충분합니다.
- 피해 결과의 추상성: '크게 다쳤다'는 표현은 '코피를 흘리고 정신을 잃어 병원에 실려 갔으며 뇌진탕 전치 3주 진단을 받았다'는 구체적인 피해 내용과 진단 결과를 반영하지 못합니다.
- 책임 유무 판단에 영향을 미칠 수 있는 주장 누락: '상대방이 먼저 욕을 했다'는 사실은 추후 정당방위 또는 양형에서 고려될 수 있는 중요한 사실임에도 단순 나열에 그쳤습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 피의자(의뢰인)는 지난 주말 술집에서 옆 테이블 손님과 언쟁이 있었다.",
    "2. 언쟁 중 상대방이 피의자에게 먼저 심한 욕설을 하였다.",
    "3. 피의자는 위 욕설에 격분하여 상대방의 얼굴을 주먹으로 2회 가격하였다.",
    "4. 위 폭행으로 상대방은 코피를 흘리고 정신을 잃었으며 병원으로 이송되었다.",
    "5. 상대방은 병원에서 뇌진탕 진단과 함께 전치 3주의 상해 진단을 받았다.",
    "6. 피의자는 위 사건과 관련하여 경찰 조사를 받았고, 상대방은 피의자를 고소하였다."
  ]
}
##👍 이유:##
- 범행 전 경위 및 동기 명시: '술집에서 언쟁이 있었고', '상대방이 먼저 심한 욕설을 했다'와 같이 범행에 이르게 된 객관적인 경위를 포함했습니다. 이는 형사 사건에서 고의성이나 양형 판단에 영향을 미칠 수 있는 중요한 사실입니다.
- 범행 방법 및 수단의 구체화: '얼굴을 주먹으로 2회 가격하였다'와 같이 폭행의 구체적인 방법과 횟수를 명확히 하여 범죄의 실행 행위를 상세히 묘사했습니다.
- 피해 내용 및 진단 결과의 상세 기술: '코피를 흘리고 정신을 잃었으며 병원으로 이송', '뇌진탕 진단 및 전치 3주 상해 진단'과 같이 피해의 구체적인 내용과 의학적 결과를 명확히 기술하여 상해의 정도를 객관적으로 드러냈습니다.
- 수사 및 절차 진행 사실: '경찰 조사를 받았다', '상대방이 피의자를 고소하였다'와 같이 수사 및 법적 절차의 진행 사실을 포함했습니다.

##사건 내용:##
"저는 김지훈입니다. 2023년 10월 15일, 박상철이라는 사람이 저에게 '새로운 코인에 투자하면 두 달 안에 원금을 두 배로 불려주겠다. 이 투자는 원금 보장이 되고 무조건 성공한다.'고 말했습니다. 저는 그 말을 믿고 제 계좌에서 박상철의 계좌로 5천만 원을 송금했습니다. 그런데 약속한 두 달이 지나도 수익은커녕 원금도 돌려받지 못했고, 박상철은 이후 전화번호를 바꾸고 잠적하여 연락이 전혀 되지 않습니다. 정말 파렴치한 사기꾼입니다. 저는 2024년 1월 10일 경찰서에 고소장을 제출했습니다."

##나쁜 답변:##
{
  "basic_facts": [
    "1. 박상철은 김지훈을 속여 돈을 받았다.",
    "2. 박상철은 돈을 들고 도망갔다.",
    "3. 김지훈은 경찰에 고소했다.",
    "4. 박상철은 나쁜 사기꾼이다."
  ]
}
##👎 이유:##
- 기망 행위의 불충분한 묘사: '속여 돈을 받았다'는 사기 행위의 본질을 명확히 보여주지 못하고, '두 달 안에 원금 두 배', '원금 보장', '무조건 성공'과 같은 구체적인 기망 내용이 누락되었습니다.
- 정보의 일반화: '2023년 10월 15일', '5천만 원 송금', '전화번호를 바꾸고 잠적', '2024년 1월 10일 고소장 제출' 등 핵심 시점과 행위의 구체성이 부족합니다.
- 주관적 판단 포함: '나쁜 사기꾼이다'는 의뢰인의 주관적인 판단이자 감정으로, 법률 사실 관계에 포함되지 않습니다.

##좋은 답변:##
{
  "basic_facts": [
    "1. 김지훈은 2023년 10월 15일 박상철로부터 '새로운 코인에 투자하면 두 달 안에 원금을 두 배로 불려주며, 원금 보장이 되고 무조건 성공한다'는 제안을 받았다.",
    "2. 김지훈은 박상철의 위 제안을 믿고 자신의 계좌에서 박상철의 계좌로 5천만 원을 송금하였다.",
    "3. 약정된 두 달이 지난 후에도 김지훈은 박상철로부터 투자 수익 및 원금을 반환받지 못하였다.",
    "4. 박상철은 위 투자금 송금 이후 전화번호를 변경하고 잠적하여 김지훈과의 연락이 두절되었다.",
    "5. 김지훈은 2024년 1월 10일 위 사기 사실에 대해 경찰서에 고소장을 제출하였다."
  ]
}
##👍 이유:##
- 기망 행위의 상세한 기술: '두 달 안에 원금 두 배', '원금 보장', '무조건 성공'과 같이 사기죄의 핵심 구성요건인 기망 행위를 구체적인 박상철의 발언 내용을 통해 명확하게 제시했습니다.
- 재산상 이익 취득의 명확화: '김지훈의 계좌에서 박상철의 계좌로 5천만 원을 송금하였다'와 같이 피해 금액과 그 이전 과정을 정확히 기술했습니다.
- 채무불이행 및 도주 정황의 상세화: '수익 및 원금 미반환', '전화번호 변경 후 잠적하여 연락 두절' 등 범행 후의 객관적인 정황을 시간순으로 구체적으로 기술하여 범죄의 증명력을 높였습니다.
- 수사 절차 시작 시점 명시: '2024년 1월 10일 경찰서에 고소장을 제출하였다'와 같이 사법 절차의 시작 시점을 정확히 명시했습니다.
            """
        },
        {
            "role": "user",
            "content": user_input
        }
    ]

    try:
        response = client.chat.completions.create(
            model="gpt-4o", # 또는 gpt-3.5-turbo 등 원하는 모델 선택
            messages=messages,
            temperature=0.3, # 사실 관계 추출이므로 약간의 유연성 허용
            response_format={"type": "json_object"}
        )
        output = response.choices[0].message.content
        parsed = json.loads(output)
        return parsed.get("basic_facts", [])
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        return []